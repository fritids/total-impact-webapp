$.ajaxSetup({cache:!1});window.console||(console={log:function(){}});var ajaxLoadImg="<img class='loading' src='../static/img/ajax-loader.gif' alt='loading...' />",ajaxLoadImgTransparent="<img class='loading' src='../static/img/ajax-loader-transparent.gif' alt='loading...' />",collectionAliases=[],currentUserInputValue="",currentlyUpdating=!1;exampleStrings={paste_input:"doi:10.123/somejournal/123\nhttp://www.example.com",crossref_input:"Watson : A Structure for Deoxyribose Nucleic Acid",name:"My Collection"};inputExamplesIClickHandler=function(e){};flatten=function(e){var t=[];numIds=e.length;for(var n=0;n<numIds;n++){var r=e[n][1],i=e[n][0];if(Object.prototype.toString.call(r)==="[object Array]")var s=r.join(",");else var s=r;t.push([i,s])}return t};addCollectionIds=function(e,t){var n=collectionAliases.length,r=flatten(e),i={};for(var s=0;s<collectionAliases.length;s++){var o=collectionAliases[s].join(":");i[o]=1}console.log(i);for(var s=0;s<r.length;s++){var u=r[s].join(":");i[u]||collectionAliases.push(r[s])}$("div.progressbar").empty();$("span.loading").remove();var a=collectionAliases.length;numIdsAdded=a-n;$("#artcounter span.count").html(a);if(numIdsAdded){t.siblings("span.added").remove();t.after("<span class='added'><span class='count'>"+numIdsAdded+"</span> items added.</span>");t.siblings("span.added").find("span.count").css({color:"#ff4e00"}).animate({color:"#555555"},1e3)}return!0};parseTextareaArtifacts=function(e){var t=e.split("\n"),n=[];for(i=0;i<t.length;i++){var r=[],s=t[i];if(s.indexOf(":")>0){r[0]=s.split(":")[0];r[1]=s.substr(r[0].length+1);if(r[0]=="http"){r[0]="url";r[1]=s}}else if(s.length>0){s.substring(0,3)=="10."?r[0]="doi":r[0]="unknown";r[1]=s}typeof r[1]!="undefined"&&n.push(r)}return n};userInputHandler=function(e,t){e.blur(function(){})};progressbar=function(e,t,n){percentDone=Math.round(t/e*100);n.html(percentDone+"% done...")};update_bibtex_progress=function(e){$.ajax({url:"http://"+api_root+"/provider/bibtex/memberitems/"+e+"?method=async",type:"GET",dataType:"json",success:function(t,n,r){console.log("searched using key "+e);console.log(t);if(t.pages==t.complete){aliases=[];for(i=0;i<t.memberitems.length;i++)aliases=aliases.concat(t.memberitems[i]);addCollectionIds(aliases,$("li #input_bibtex"))}else{progressbar(t.pages,t.complete,$("#bibtex_toggler_contents div.progressbar"));setTimeout(function(){update_bibtex_progress(e)},500)}},error:function(e,t,n){$("span.loading").remove();$("li #input_bibtex").siblings("span.added").remove();$("li #input_bibtex").after("<span class='added'><span class='sorry'>sorry, there was an error.</span></span>")}})};upload_bibtex=function(e){var t=$("li #input_bibtex")[0],n=t.files[0],r=new FormData;r.append("file",n);$("li #input_bibtex").siblings("span.added").remove();$("li #input_bibtex").after("<span class='loading'>"+ajaxLoadImg+"<span>");console.log("starting ajax request now.");progressbar(1,0,$("#bibtex_toggler_contents div.progressbar"));$.ajax({url:"http://"+api_root+"/provider/bibtex/memberitems",type:"POST",processData:!1,contentType:!1,timeout:12e4,data:r,success:function(e,t,n){console.log("started update request; got this key back: "+e);update_bibtex_progress(e)},error:function(e,t,n){$("li #input_bibtex").siblings("span.added").remove();$("li #input_bibtex").siblings("span.loading").remove();$("li #input_bibtex").after("<span class='added'><span class='sorry'>sorry, there was an error.</span></span>")}})};createCollectionInit=function(){$("li textarea, input#name").each(function(){$(this).val(exampleStrings[this.id])});$("li input, li textarea, input#name").focus(function(){currentUserInputValue=$(this).val();$(this).removeClass("no-input-yet");currentUserInputValue==exampleStrings[this.id]&&$(this).val("")}).blur(function(){$this=$(this);if($this.val()==""){$this.addClass("no-input-yet");$this.val(exampleStrings[this.id]);return!1}if($this.val()==currentUserInputValue)return!1;if($this.attr("id")=="paste_input"){newIds=parseTextareaArtifacts($(this).val());newIds=newIds.slice(0,500);addCollectionIds(newIds,$(this))}else if($this.attr("id")!="name"){var e=$(this).attr("id").split("_"),t=e[0];if(t=="crossref")var n="&type=import",r=$this.val().replace(":","|"),i=escape(r);else var i=escape($this.val());$(this).siblings("span.added").remove();$(this).not("input#name").after("<span class='loading'>"+ajaxLoadImg+"<span>");console.log("running memberitems");$.ajax({url:"http://"+api_root+"/provider/"+t+"/memberitems/"+i+"?method=sync",type:"GET",dataType:"json",success:function(e,t,n){addCollectionIds(e.memberitems,$this)},error:function(e,t,n){$("span.loading").remove();$this.siblings("span.added").remove();var r;e.status==404?r="sorry, not found.":r="sorry, there was an error.";$this.after("<span class='added'><span class='sorry'>"+r+"</span></span>")}})}});$("#id-form").submit(function(){if(collectionAliases.length==0){alert("Looks like you haven't added any research objects to the collection yet.");return!1}console.log("adding collection with new items.");$("#go-button").replaceWith("<span class='loading'>"+ajaxLoadImg+"<span>");var e={title:$("#name").val(),aliases:collectionAliases};$.ajax({url:"http://"+api_root+"/collection",type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(e),success:function(e){returnedCollection=e.collection;user.addColl(returnedCollection._id,e.key);var t=$("#inline-register-email").val(),n=$("#inline-register-pw").val();t&&n&&user.setCreds(t,n);var r=function(){location.href="/collection/"+returnedCollection._id};user.hasCreds()?user.syncWithServer("push",{on200:r}):r()}});return!1})};$(document).ready(function(){$.cookie.defaults={path:"/",raw:1};userViews=new UserViews;user=new User(userViews);userController=new UserController(user,userViews);userController.init();collViews=new CollViews;coll=new Coll(collViews);collController=new CollController(coll,collViews);$("div#paste-ids legend a").click(function(){TINY.box.show({url:"../static/whichartifacts.html"});return!1});$("#toc")[0]&&$("#toc").tocBuilder({type:"headings",startLevel:3,endLevel:3,insertBackLinks:0});createCollectionInit()});